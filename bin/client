#!/usr/bin/env ruby

require 'forwardable'
require 'pry'
require 'xmpp4r'
require 'xmpp4r/client'
require 'xmpp4r/muc'
require 'xmpp4r/roster'


$stdout.sync = true

JID     = ARGV.shift
PASS    = File.read(ARGV.shift).chomp
LOGGER  = Logger.new($stdout).tap do |o|
  #o.level     = Logger::DEBUG
  o.level     = Logger::INFO
  o.formatter = proc do |severity, datetime, progname, message|
    "%s.%03i %s: %s\n" % [
      datetime.strftime('%FT%T'),
      datetime.usec / 1000,
      severity[0..0],
      message
    ]
  end
end


def log message
  print "\e[1G"
  LOGGER.info message
  Readline.refresh_line
end


class Client
  extend Forwardable
  def_delegators  :@client, :connect, :auth
  def_delegator   :@client, :close, :disconnect
  def_delegator   :@client, :send, :xsend

  def initialize jid
    @client = Jabber::Client.new(jid)
    setup_callbacks
  end

  def presence p = :available
    @client.send Jabber::Presence.new.set_type p
    :ok
  end

  def roster
    Jabber::Roster::Helper.new(@client)
  end

  def msg recipient, body
    @client.send Jabber::Message.new(recipient, body)
    :ok
  end

  def join channel
    muc = Jabber::MUC::SimpleMUCClient.new(@client)
    muc.on_message do |time, nick, text|
      log "[#{channel}] <#{nick}> #{text.inspect}"
    end
    muc.join Jabber::JID.new(channel)
    :ok
  end


  private

  def setup_callbacks
    @client.add_message_callback do |message|
      $__ = message
      case message.type
      when :chat
        log "<#{message.from}> #{message.body.inspect}"
      else
        log '%s <%s> %s' % [
          message.type,
          message.respond_to?(:from) ? message.from : '?',
          message.body
        ]
      end
    end
  end
end

class Interactor
  PRY_PROMPT = %w[> *].map.with_index do |char, i|
    proc do |target_self, nest_level, pry|
      case target_self
      when self
        char + ' '
      else
        Pry::DEFAULT_PROMPT[i].call target_self, nest_level, pry
      end
    end
  end

  class << self
    def run_authenticated jid, password = nil
      i = new jid
      i.connect
      i.auth password if password
      Pry.start i, prompt: PRY_PROMPT
      i.terminate
    end
  end

  extend Forwardable
  def_delegators :@client, :connect, :register_info, :auth,
    :presence, :roster,
    :msg, :join

  def initialize jid
    @client = Client.new(jid)
  end

  def terminate
    @client.disconnect
  end

  def register
    puts 'password:'
    password = $stdin.gets.chomp
    @client.register password
  end

  def chpass
    puts 'password:'
    password = $stdin.gets.chomp
    @client.password = password
  end
end


#Jabber.debug = true
Interactor.run_authenticated(JID, PASS)
